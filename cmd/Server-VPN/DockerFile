FROM golang:1.24.4-alpine

# Install required packages
RUN apk add --no-cache iptables iproute2 gcc musl-dev linux-headers

WORKDIR /app

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build the server
RUN go build -o server ./cmd/Server-VPN/main.go

# Enable IP forwarding and NAT
CMD sysctl -w net.ipv4.ip_forward=1 && \
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE && \
    ./server